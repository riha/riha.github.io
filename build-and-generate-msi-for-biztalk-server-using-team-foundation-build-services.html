<!doctype html>
<html lang="en-US">
  <head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <title>
    Gobbledygooks
    
      &middot; Build and generate MSI for BizTalk Server using Team Foundation Build Services
    
  </title>

  <!-- Sitemap -->
  <link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml">

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="riha feed" href="http://richardhallgren.com/feed">
</head>

  <body class="bg-bg-yellow flex justify-center font-mono py-4 px-4 post-page">
    <div class="max-w-[750px]">
      <div class="">
        <div class="flex justify-center">
          <a href="/">
            <img
              src="/assets/riha-profile-image.jpeg"
              class="rounded-full w-32 border-profile-border shadow profile-image"
            >
          </a>
        </div>
      </div>
      <div class="my-12"></div>

      <h1>Build and generate MSI for BizTalk Server using Team Foundation Build Services</h1>
      <div class="my-1"></div>
      <div class="text-center text-text-subtle text-sm">Feb 26, 2015</div>
      <div class=" my-12">
        <p>Using a build server and leveraging continuous integration is good practice in any software 
development project. The idea behind automated build and continuous integrations is to have a server that 
monitors one’s source code repository and builds the solution as changes occur. This separate build 
activity alone will ensure that all artifacts are checked in and that a successful build doesn’t depend on any artifacts or settings on the development machines.</p>

<p><img src="https://www.dropbox.com/s/jepbxxkn38ixy3e/1.png?raw=1" alt="Build server" /></p>

<p>Today build servers do a lot more as part of the build - the build process usually involves execution of 
tests, labeling the source as well as packing the solution into a deployable artifact.</p>

<p>In this post we’ll see how a build process can be achieved using Team Foundation (TFS) Build Services, building a BizTalk project that results in 
a deployable MSI artifact.</p>

<h2 id="tfs-build-services">TFS Build Services</h2>
<p><a href="https://msdn.microsoft.com/en-us/library/ee259687.aspx">TFS Build services</a> is a component that is part of the standard TFS install media. 
Each TFS build controller controls a number of “Build Agents” that will perform the actual build process. For each solution to build one has to 
define its process. These processes are described in a “Build Template” that tells the agent what steps to go through 
and in what order.</p>

<p>“Build Templates” in TFS Build Services are defined using Visual Studio. The image below shows a build template accessed through Visual Studio Team Explorer.</p>

<p><img src="https://www.dropbox.com/s/4n5dmiepn0bmrzb/2.png?raw=1" alt="Visual Studio Team Explorer Build Templates" /></p>

<h3 id="major-steps-in-a-build-template">Major steps in a build template</h3>
<p>As one creates a new build template for a solution one has to go through the following major steps:</p>

<p><strong>1. Define a trigger</strong></p>

<p>Decides what should trigger the build. Should it be triggered manually, should it be a scheduled build or should it 
be triggered at a check-in of new code?</p>

<p><strong>2. Source Setting</strong></p>

<p>This will tell the build process what part of the source tree the build template is relevant for. When queueing 
a new build this is the part of the source tree that will be downloaded to the staging area. It also tells the build 
services where on disk the source should be downloaded to.</p>

<p><strong>3. Process</strong></p>

<p>This is where all the steps and activities that the build service should perform are defined. Team Foundation Build 
Services comes with a number of standard templates and custom ones can be added. In this post we’ll however stick with the default one.</p>

<h2 id="build-your-first-biztalk-solution">Build your first BizTalk solution</h2>

<p>Building BizTalk Server solution using TFS Build Services is straight forward.</p>

<p>In this post I will use <a href="https://github.com/riha/BtsMsiTask/tree/master/Sample">this sample</a> BizTalk solution. After checking it into Team 
Foundation Source Control (I’ll use TFS Source control in this post but it’ll work similarly using Git) I’ll create a new build template for the solution. All that’s 
needed to change is the MsBuild platform setting property, so we’re using x86 when executing MsBuild as shown below.</p>

<p><img src="https://www.dropbox.com/s/lgcnk72pqko72s2/3.png?raw=1" alt="Build process and the MsBuild platform setting property" /></p>

<p>After queuing a build we can in the TFS Build Explorer see a successful build!</p>

<p><img src="https://www.dropbox.com/s/u5lpl4hw7h7jxjx/4.png?raw=1" alt="Successful build in TFS Build Explorer" /></p>

<p>We can also download the output from the build where we can see all our build artifacts!
<img src="https://www.dropbox.com/s/erx3twhocbelfyq/5.png?raw=1" alt="First artifact drop" /></p>

<h2 id="using-btsmsitask-to-create-a-msi-as-part-of-the-build">Using BtsMsiTask to create a MSI as part of the build</h2>
<p>So far so good, but we started the article by saying that what we wanted was a deployable artifact. In the case of 
BizTalk this means a BizTalk MSI. Let’s see what we need to change to also have the build process create a MSI.</p>

<p><strong>1. Install BtsMsiTask</strong></p>

<p>Download and install <a href="http://richardhallgren.com/BtsMsiTask/">BtsMsiTask</a>. This will install a MsBuild task for generating the MSI.</p>

<p><strong>2. Add a MsBuild project file</strong></p>

<p>Add a MsBuild project file (<code class="language-plaintext highlighter-rouge">build.proj</code>) to the solution</p>

<script src="https://gist.github.com/riha/24856902e68bae4ec244.js"></script>
<p>The project file will tell the BtsMsiTask process what artifacts to include. 
Add the created project file to the solution and check it in as part of the solution.</p>

<p><strong>3. Add the MsBuild project file to the TFS build template</strong></p>

<p>Add the created MsBuild project file to the TFS build template by adding it to the list of projects to build.</p>

<p><img src="https://www.dropbox.com/s/6avtnovpdkzo0ll/6.png?raw=1" alt="Adding the build file to the build process" /></p>

<p>After another successful build we can see that we also created a MSI as part of the build!
<img src="https://www.dropbox.com/s/qtbd8pp552x9y6p/7.png?raw=1" alt="Successful build with msi" /></p>

<h2 id="adding-build-information-to-the-msi">Adding build information to the MSI</h2>
<h3 id="file-name">File name</h3>
<p>As we can see the MSI we just created ended up with the default BtsMsiFile name that is a combination of the BizTalk application name property and the 
current date and time. Wouldn’t it be nice of we instead could the build number as part of the name?
BtsMsiTask has an <a href="http://richardhallgren.com/BtsMsiTask/available-parameters/">optional property</a> called <code class="language-plaintext highlighter-rouge">FileName</code> that we for 
example can set to <code class="language-plaintext highlighter-rouge">&lt;FileName&gt;$(TF_BUILD_BUILDNUMBER).msi&lt;/FileName&gt;</code></p>

<h3 id="source-location">Source location</h3>
<p>When installing the artifact to BizTalk Server we can see that the source location property in the BizTalk Administration Console is set to 
where the artifact was built on the staging area. 
<img src="https://www.dropbox.com/s/8c7usslwvijnj75/8.png?raw=1" alt="Source Location without build number" /></p>

<p>It’d be nice to also have information about what build that produced these artifacts. This will give the required information to know exactly what builds that are used for all the installed artifacts.</p>

<p>We can change what is set in the source location by using the <code class="language-plaintext highlighter-rouge">SourceLocation</code> property of BtsMsiTask <code class="language-plaintext highlighter-rouge">&lt;SourceLocation&gt;c:\$(TF_BUILD_BUILDNUMBER)&lt;/SourceLocation&gt;</code></p>

<p>So after setting the property as below, queue another build, reinstall using the MSI and we’ll get the following result with the build number in the source location property.
<img src="https://www.dropbox.com/s/fkjxfdyqyp7vf86/9.png?raw=1" alt="Source Location with build number" /></p>

<p>And finally this is the MsBuild project file we ended up with in our example. <script src="https://gist.github.com/riha/dd8d7b4a1fed1bad3ca5.js"></script></p>


      </div>
      <div class="mt-6" />
<div class="flex items-baseline justify-center gap-4">
  <a href="https://www.linkedin.com/in/richardhallgren/">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="lucide lucide-linkedin"
    >
      <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" />
      <rect width="4" height="12" x="2" y="9" />
      <circle cx="4" cy="4" r="2" />
    </svg>
  </a>
  <a href="mailto:richard@revision.app">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="lucide lucide-mail"
    >
      <rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
    </svg>
  </a>
</div>

    </div>
  </body>
</html>

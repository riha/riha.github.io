---
date: 2015-02-15 12:00:0+01:00
layout: post
title: "TODO"
---
Build and generate MSI:s for BizTalk Server using Team Foundation Build Services

Using a build server and leveraging continuous integration is good practice in any software 
development project. The idea behind automated build and continuous integrations is to have a server that 
monitors once source code repository and that builds the whole solution as changes occurs. This separate build 
activity alone will ensure that all artefact are checked in and that a successful build doesn’t depend on any 
artefact or settings on the development machine.

Today build servers however do a lot more as part of the build and the build process usually involves execution of 
tests, labeling the source as well as packing the solution into a deployable artefact.

## Team Foundation Build Services
TFS Build services is a component that is part of the standard TFS install media. Each TFS build controller 
controls a number of Build Agents that will perform the actual build process. For each solution to build one has to 
define its process. These processes are described in a Build Template that tells the agent what steps to go through 
and in what order.

BILD 1 som skall visa hur det hänger ihop

The image below show a Build Template accessed thru Visual Studio Team Explorer.

![link to Google](https://www.dropbox.com/s/qmifhapfsaxkjlb/1.png?raw=1)

### Major steps in a build template
As one creates a new Build Definition for a solution one has to go thru the following major steps:
#### Trigger
Decides what wil trigger the build, should it be triggered manually, should be a scheduled build or should it 
be triggered at a checkin of new code to the code repository.

#### Source Setting
This will tell Visual Studio first what part of the source tree the build template is relevant for. When staring 
a new build this is the part of the source tree that will be downloaded to the staging are. It also tells the build 
services where on disk the source should be places.
#### Process
This is where all the steps and activities that the build service should perform is defined. Team Foundation Build 
Services comes with a number and templates and one can add custom ones. 

### Build your first BizTalk solution
Building BizTalk solution using Team Foundation Build services are straight forward. 

After downloading [this sample](https://github.com/riha/BtsMsiTask/tree/master/Sample) and checked it into Team 
Foundation I’ll create a new Build Template. 
All that needed to change is the MsBuild platform setting so we’re using x86 when executing MsBuild
 
Bild 3 som skall visa hur det ser ut under processes

After our first successful build we can in the Build Explotrer see a successful build!

Bild 4 som skall visa build explorer
 
We can also download the output from the build where we can see all out build artefacts!
 
## Using BtsMsiTask to create a MSI as part of the build
Now that all good but we started the article by saying that what we wanted was a deployable artefact. In the case of 
BizTalk this means a BizTalk MSI. Let’s see what we need to change to also have the build process create a MSI.
1. Install BtsMsiTask
Donwload and install BtsMsiTask. This will install a number of MsBuild task for generating the MSI.

2. Add a proj file to the solution
Denna filen skall jag l’ägga upp som en gist!
The project file will tell the BtsMsiTask process what aretafect to include, what msi file namn to set and so on. 
Add the project file to the solution and check it in as part of the solution.

3. Add project file to the Build Template by adding it to list of project to build

After another successful build we can see that we also created a MSI as part of the build!
 
## Adding build information to the MSI
### File name
As we can see the MSI we just created ended up with the default BtsMsiFile name that is a combination of the BizTalk application name property and the current date and time. Would it be nice of we instead could the build number as part of the name?
BtsMsiTask has an optional property called file name that we for example can set to 

<FileName>$(TF_BUILD_BUILDNUMBER).msi</FileName>

### Source location
When installing the artefact to BizTalk we can also see that the source location is set to where the artefat was build on the stagin area. It be nice to also here have information about what build that built these arefacts.
 
We can change what set in the source loication by using the the source location property of BtsMsiTask. So after setting the property as below, build again and resínstall we get the following.
 


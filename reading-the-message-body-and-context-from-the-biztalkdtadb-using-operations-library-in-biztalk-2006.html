<!doctype html>
<html lang="en-US">
  <head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <title>
    Gobbledygooks
    
      &middot; Reading the message body and context from the BizTalkDTADb using operations library in BizTalk 2006
    
  </title>

  <!-- Sitemap -->
  <link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml">

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="riha feed" href="http://richardhallgren.com/feed">
</head>

  <body class="bg-bg-yellow flex justify-center font-mono py-4 px-4 post-page">
    <div class="max-w-[750px]">
      <div class="">
        <div class="flex justify-center">
          <a href="/">
            <img
              src="/assets/riha-profile-image.jpeg"
              class="rounded-full w-32 border-profile-border shadow profile-image"
            >
          </a>
        </div>
      </div>
      <div class="my-12"></div>

      <h1>Reading the message body and context from the BizTalkDTADb using operations library in BizTalk 2006</h1>
      <div class="my-1"></div>
      <div class="text-center text-text-subtle text-sm">Jun 04, 2007</div>
      <div class=" my-12">
        <p><strong>Update 2007-07-05:</strong> The example project used in the post can be <a href="http://www.richardhallgren.com/blogfiles/BizTalkDTAReader.zip">downloaded from here</a>.</p>

<p>The operations dll (<em>Micrsoft.BizTalk.Operations</em>) is one of the new bits in BizTalk 2006 that at least I haven’t heard much about (most of you probably find in the <em>C:\Program Files\Microsoft BizTalk Server 2006</em> folder). However it’s a library with a lot of useful functionality.</p>

<p>In this post I’ll focus on how it’s possible to use the library to get hold of message parts and message context from the BizTalk tracking database (usually called the <em>BizTalkDTADb</em>). If you’re unfamiliar with the architecture of the tracking in BizTalk <a href="http://msdn2.microsoft.com/en-us/library/aa559554.aspx">this article</a> is a good place to start.</p>

<h2 id="what-used-to-be-the-problem">What used to be the problem?</h2>

<p>In BizTalk 2004 one soon got into problems when trying to read the message parts and the message context from the tracking database. The problem is that the the Xml is compressed (something that makes totally sence - Xml is a perfect candidate for compression). To my knowledge no one has found a good way to decompress the message context. There’s however a way to decompress <strong>the message parts</strong> (and only the parts) that <a href="http://groups.google.com/group/microsoft.public.biztalk.general/browse_thread/thread/599c038807317802">Rob posted on in the BizTalk newsgroup</a>. But this method doesn’t work on the compressed context of the same message that the parts belong to! One could assume that the same method could be used for both compression and decompression but I haven’t got it to work for the context of the message (read about my frustration <a href="http://groups.google.com/group/microsoft.public.biztalk.general/browse_thread/thread/19a232369218b2f9">here</a>)</p>

<h2 id="whats-wrong-with-wmi-and-msbts_trackedmessageinstance">What’s wrong with WMI and <em>MSBTS_TrackedMessageInstance</em>?</h2>

<p>So the option that was left to us before BizTalk 2006 for reading all the message parts as well as the message context was to use the <a href="http://msdn2.microsoft.com/en-us/library/aa546797.aspx">MSBTS_TrackedMessageInstance WMI scrtipt</a> and save everything down to file. The problem with this approach is that it’s slow and ugly! Say that we like to save a couple of thousand messages from the tracking database. When forced to save the messages to file we’ll end up with a slow and ugly solution where writing to file takes ages, then we have to read the content of the different files before cleaning up and deleting the files.</p>

<h2 id="micrsoftbiztalkoperations-to-the-rescue">Micrsoft.BizTalk.Operations to the rescue</h2>

<p>A quick view in <a href="http://www.aisto.com/roeder/dotnet/">Lutz Roeder’s Reflector</a> shows us a couple of interesting methods in the operations dll. However I’ll only use the <em>GetTrackedMessage</em> method in this post.</p>

<p><a href="../assets/2007/06/operations1.jpg"><img src="../assets/2007/06/operations-thumb1.jpg" alt="operations" /></a></p>

<p>I’ve written a tiny test application that uses the library to read the body part of the message (the meat of the message) and a couple of properties I’m interested in from the context of the message. It looks something like this. If your interested drop me an email and I’ll send it. The first screenshot below shows an example of reading the <em>InterchangeID</em> from the context of a tracked message.</p>

<p><a href="../assets/2007/06/operationstest22.jpg"><img src="../assets/2007/06/operationstest2-thumb2.jpg" alt="OperationsTest2" /></a></p>

<p>This screenshot shows an example of reading the full body of a tracked message from the tracking database. Try doing this with less then 10 lines of code using the <em>MSBTS_TrackedMessageInstance</em> script!</p>

<p><a href="../assets/2007/06/operationstest11.jpg"><img src="../assets/2007/06/operationstest1-thumb1.jpg" alt="OperationsTest1" /></a></p>

<p>There is really nothing to the application, reading a tracked message using the <em>MessageID</em> will return an object implementing <em><a href="http://msdn2.microsoft.com/en-us/library/microsoft.biztalk.message.interop.ibasemessage_members.aspx">IBaseMessage</a></em> and we basically read the <em><a href="http://msdn2.microsoft.com/en-us/library/microsoft.biztalk.message.interop.ibasemessage.bodypart.aspx">BodyPart</a></em> property of - it really couldn’t be any easier.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div&gt;&lt;span style="color: #0000FF; "&gt;public&lt;/span&gt;&lt;span style="color: #000000; "&gt; &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;static&lt;/span&gt;&lt;span style="color: #000000; "&gt; &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;string&lt;/span&gt;&lt;span style="color: #000000; "&gt; GetMessageBodyByMessageID(&lt;/span&gt;&lt;span style="color: #0000FF; "&gt;string&lt;/span&gt;&lt;span style="color: #000000; "&gt; dbServer, &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;string&lt;/span&gt;&lt;span style="color: #000000; "&gt; dbName, Guid messageID)
{
    TrackingDatabase dta &lt;/span&gt;&lt;span style="color: #000000; "&gt;=&lt;/span&gt;&lt;span style="color: #000000; "&gt; &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;new&lt;/span&gt;&lt;span style="color: #000000; "&gt; TrackingDatabase(dbServer, dbName);
    BizTalkOperations operations &lt;/span&gt;&lt;span style="color: #000000; "&gt;=&lt;/span&gt;&lt;span style="color: #000000; "&gt; &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;new&lt;/span&gt;&lt;span style="color: #000000; "&gt; BizTalkOperations();
    IBaseMessage message &lt;/span&gt;&lt;span style="color: #000000; "&gt;=&lt;/span&gt;&lt;span style="color: #000000; "&gt; operations.GetTrackedMessage(messageID, dta);
    &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;string&lt;/span&gt;&lt;span style="color: #000000; "&gt; body &lt;/span&gt;&lt;span style="color: #000000; "&gt;=&lt;/span&gt;&lt;span style="color: #000000; "&gt; &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;string&lt;/span&gt;&lt;span style="color: #000000; "&gt;.Empty;
    &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;using&lt;/span&gt;&lt;span style="color: #000000; "&gt;(StreamReader streamReader &lt;/span&gt;&lt;span style="color: #000000; "&gt;=&lt;/span&gt;&lt;span style="color: #000000; "&gt; &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;new&lt;/span&gt;&lt;span style="color: #000000; "&gt; StreamReader(message.BodyPart.Data))
    {
        body &lt;/span&gt;&lt;span style="color: #000000; "&gt;=&lt;/span&gt;&lt;span style="color: #000000; "&gt; streamReader.ReadToEnd();
    }

    &lt;/span&gt;&lt;span style="color: #0000FF; "&gt;return&lt;/span&gt;&lt;span style="color: #000000; "&gt; body;
} &lt;/span&gt;&lt;/div&gt;
</code></pre></div></div>

<p>I’d be very interested in how people use the operations library both when it comes to read and use tracked messages, but also in other ways! Use the comments to tell me and other readers how you use it your solutions!</p>

      </div>
      <div class="mt-6" />
<div class="flex items-baseline justify-center gap-4">
  <a href="https://www.linkedin.com/in/richardhallgren/">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="lucide lucide-linkedin"
    >
      <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" />
      <rect width="4" height="12" x="2" y="9" />
      <circle cx="4" cy="4" r="2" />
    </svg>
  </a>
  <a href="mailto:richard@revision.app">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="lucide lucide-mail"
    >
      <rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
    </svg>
  </a>
</div>

    </div>
  </body>
</html>

<!doctype html>
<html lang="en-US">
  <head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <title>
    Gobbledygooks  &middot; Streaming pipeline and using context ResourceTracker to avoid disposed streams 
  </title>

  <!-- Sitemap -->
  <link
    href="/sitemap.xml"
    rel="sitemap"
    title="Sitemap"
    type="application/xml"
  />

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css">

  <!-- Fathom - beautiful, simple website analytics -->
  <script
    src="https://cdn.usefathom.com/script.js"
    data-site="JOYKGAUK"
    defer
  ></script>
  <!-- / Fathom -->

  <!-- RSS -->
  <link
    rel="alternate"
    type="application/atom+xml"
    title="riha feed"
    href="http://richardhallgren.com/feed"
  />
</head>

  <body class="bg-bg-yellow max-w-[650px]  font-mono  post-page px-4 py-4 " style="margin: 0 auto;" >
    <div class=" ">
      <div class="">
        <div class="flex justify-center">
          <a href="/">
            <img
              src="/assets/riha-profile-image.jpeg"
              class="rounded-full w-32 border-profile-border shadow profile-image"
            >
          </a>
        </div>
      </div>
      <div class="my-12"></div>

      <h1>Streaming pipeline and using context ResourceTracker to avoid disposed streams</h1>
      <div class="my-1"></div>
      <div class="text-center text-text-subtle text-sm">Feb 22, 2010</div>
      
        <p>Recently there’s been a few really good resources on streaming pipeline handling published. You can find some of the <a href="http://msdn.microsoft.com/en-us/library/ee377071(BTS.10).aspx">here</a> and <a href="http://msdn.microsoft.com/en-us/library/ff384124(BTS.10).aspx">here</a>.</p>

<p>The <a href="http://msdn.microsoft.com/en-us/library/ee377071(BTS.10,classic).aspx">Optimizing Pipeline Performance</a> MSDN article has two great examples of how to use some of the <a href="http://technet.microsoft.com/en-us/library/microsoft.biztalk.streaming(BTS.20).aspx">Microsoft.BizTalk.Streaming.dl</a> classes. The execute method of first example looks something like below.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public IBaseMessage Execute(IPipelineContext context, IBaseMessage message)
{
    try
    {
        ...
        IBaseMessageContext messageContext = message.Context;
        if (string.IsNullOrEmpty(xPath) &amp;&amp; string.IsNullOrEmpty(propertyValue))
        {
            throw new ArgumentException(...);
        }
        IBaseMessagePart bodyPart = message.BodyPart;
        Stream inboundStream = bodyPart.GetOriginalDataStream();
        VirtualStream virtualStream = new VirtualStream(bufferSize, thresholdSize);
        ReadOnlySeekableStream readOnlySeekableStream = new ReadOnlySeekableStream(inboundStream, virtualStream, bufferSize);
        XmlTextReader xmlTextReader = new XmlTextReader(readOnlySeekableStream);
        XPathCollection xPathCollection = new XPathCollection();
        XPathReader xPathReader = new XPathReader(xmlTextReader, xPathCollection);
        xPathCollection.Add(xPath);
        bool ok = false;
        while (xPathReader.ReadUntilMatch())
        {
            if (xPathReader.Match(0) &amp;&amp; !ok)
            {
                propertyValue = xPathReader.ReadString();
                messageContext.Promote(propertyName, propertyNamespace, propertyValue);
                ok = true;
            }
        }
        readOnlySeekableStream.Position = 0;
        bodyPart.Data = readOnlySeekableStream;
    }
    catch (Exception ex)
    {
        if (message != null)
        {
            message.SetErrorInfo(ex);
        }
        ...
        throw ex;
    }
    return message;
}
</code></pre></div></div>

<p>We used this example as a base when developing something very similar in a recent project. At first every thing worked fine but after a while we stared getting an error saying:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cannot access a disposed object. Object name: DataReader
</code></pre></div></div>

<p>It took us a while to figure out the real problem here, everything worked fine when sending in simple messages but as soon as we used to code in a pipeline were we also <a href="http://geekswithblogs.net/benny/archive/2007/02/15/106329.aspx">debatched</a> messages we got the “disposed object” problem.</p>

<p><a href="../assets/2010/02/image1.png"><img src="../assets/2010/02/image_thumb1.png" alt="image" /></a>It turns out that when we debatched messages the execute method of the custom pipeline ran multiple times, one time for each sub-messages. This forced the .NET Garbage Collector to run.</p>

<p>The GC found the XmlTextReader that we used to read the stream as unreferenced and decided to destoy it.</p>

<p>The problem is that <strong>will also dispose the readOnlySeekable-Stream stream that we connected to our message data object</strong>!</p>

<p><strong>It’s then the BizTalk End Point Manager (EPM) that throws the error as it hits a disposed stream object when trying to read the message body and save it to the BizTalkMsgBox!</strong></p>

<h3 id="resourcetracker-to-the-rescue">ResourceTracker to the rescue!</h3>

<p>Turns out that the BizTalk message context object has a nice little class connected to it called the <em>ResourceTracker</em>. This object has a “AddResouce”-method that makes it possible to add an object and the context will the hold a reference to this object, <strong>this will tell the GC not to dispose it!</strong></p>

<p>So when adding the below before ending the method everything works fine - even when debatching messages!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>context.ResourceTracker.AddResource(xmlTextReader);
</code></pre></div></div>

      
      <div class="mt-6" />
<div class="flex items-baseline justify-center gap-4">
  <a href="https://www.linkedin.com/in/richardhallgren/">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="lucide lucide-linkedin"
    >
      <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" />
      <rect width="4" height="12" x="2" y="9" />
      <circle cx="4" cy="4" r="2" />
    </svg>
  </a>
  <a href="mailto:richard@revision.app">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="lucide lucide-mail"
    >
      <rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
    </svg>
  </a>
</div>

    </div>
  </body>
</html>
